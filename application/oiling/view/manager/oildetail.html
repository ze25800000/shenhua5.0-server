<?php require(APP_PATH.'/oiling/view/manager/common/header.html');?>
<div id="container">
    <div id="hd">
        <div class="hd-wrap ue-clear">
            <div class="top-light"></div>
            <h1 class="logo"></h1>
            <div class="login-info ue-clear">
                <div class="welcome ue-clear">欢迎您,&nbsp;<a href="/user/center">*{$account} </a></div>
            </div>
            <div class="toolbar ue-clear">
                <a href="/" class="home-btn">首页</a>
                <a href="javascript:;" class="quit-btn exit"></a>
            </div>
        </div>
    </div>
    <div id="bd">
        <div class="wrap ue-clear">
            <div class="sidebar">
                <h2 class="sidebar-header"><p>功能导航</p></h2>
                <ul class="nav">
                    <li class="office">
                        <div class="nav-header"><a href="standard" class="ue-clear"><span>设备润滑标准</span><i
                                class="icon"></i></a></div>
                    </li>
                    <li class="gongwen">
                        <div class="nav-header"><a href="info" class="ue-clear"><span>润滑提示与记录</span><i
                                class="icon"></i></a></div>
                    </li>
                    <li class="nav-info">
                        <div class="nav-header"><a href="analysis" class="ue-clear"><span>油脂化验指标分析</span><i
                                class="icon"></i></a></div>
                    </li>
                    <li class="konwledge current">
                        <div class="nav-header"><a href="oildetail" class="ue-clear"><span>润滑保养成本管理</span><i
                                class="icon"></i></a></div>
                    </li>
                </ul>
            </div>
            <div class="content">
                <div class="title">
                    <h2>润滑保养成本管理</h2>
                    *{if condition="$scope>=18"}
                    <div class="temp-btn-group">
                        下载模板：
                        <a style="width: 160px;" class="excel-temp-btn"
                           href="/download/template?exceltype=oildetail">润滑保养成本管理excel模板</a>
                    </div>
                    *{/if}
                </div>
                *{if condition="$scope>=18"}
                <div class="title">
                    <div class="uploader orange oildetail">
                        <form>
                            <span>批量上传润滑保养成本管理：</span>
                            <a href="javascript:;" class="a-upload">
                                <input type="file" name="excel" id=""><span class="showFileName">点击这里上传文件</span>
                            </a>
                            <input type="button" name="file" data-param="exceltype=oildetail"
                                   class="button upload" value="上传"/>
                        </form>
                    </div>
                </div>
                *{/if}
                <div class="query">
                    <div class="query-conditions ue-clear">
                        <div class="conditions time ue-clear">
                            <label>时&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;间：</label>
                            <div class="time-select">
                                <input id="monthly1" type="text" placeholder="开始时间">
                                <i class="icon"></i>
                            </div>
                            <span class="line">-</span>
                            <div class="time-select">
                                <input id="monthly2" type="text"
                                       placeholder="结束时间">
                                <i class="icon"></i>
                            </div>
                        </div>
                        <div class="query-btn ue-clear cost-confirm">
                            <a href="javascript:;" class="confirm">查询</a>
                        </div>
                        <div class="total-box ue-clear">
                            <span class="date">2017-01至2018-01</span>
                            <span class="zongji">总计：</span>
                            <span class="num">21701元</span>
                        </div>
                    </div>
                </div>
                <div class="table-box">
                    <div class="scroll-box" style="overflow: hidden;overflow-y: auto">
                        <table>
                            <thead>
                            <tr>

                                <th class="process">物料编号</th>
                                <th class="process">油品名称</th>
                                <th class="process">物料描述</th>
                                <th class="process">单位</th>
                                <th class="process">单价(元)</th>
                                <th class="process">用量</th>
                                <th class="process">总计(元)</th>
                                <th class="operate">操作</th>
                            </tr>
                            </thead>
                            <tbody id="costTbody">

                            </tbody>
                            <script type="text/html" id="costTemplate">
                                {{each(i,item) data}}
                                <tr>
                                    <td class="process edit-item" data-id="${item.id}" data-key="oil_no">
                                        ${item.oil_no}
                                    </td>
                                    <td class="process edit-item" data-id="${item.id}" data-key="oil_name">
                                        ${item.oil_name}
                                    </td>
                                    <td class="process edit-item" data-id="${item.id}" data-key="detail">
                                        ${item.detail}
                                    </td>
                                    <td class="process edit-item" data-id="${item.id}" data-key="unit">${item.unit}</td>
                                    <td class="process edit-item" data-id="${item.id}" data-key="price">
                                        ${item.price}
                                    </td>
                                    <td class="process ">${item.how_much}</td>
                                    <td class="process total">${item.total}</td>
                                    <td class="operate table-operate">
                                        <a class="edit getEquName" data-oil_no="${item.oil_no}"
                                           href="javascript:;">查看</a>
                                        <a class="del delOilDetailItem" data-id="${item.id}" href="javascript:;">删除</a>
                                    </td>
                                </tr>
                                {{/each}}
                            </script>
                        </table>
                    </div>
                </div>
                <div class="tanchuang-equlist">
                    <div class="tan-box">
                        <h2>查看所属设备列表</h2>
                        <div class="hint3"></div>
                        <table>
                            <thead>
                            <tr>
                                <th>润滑点名称</th>
                                <th>润滑时间</th>
                                <th>用量</th>
                            </tr>
                            </thead>
                            <tbody id="tanBody">
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <script type="text/html" id="tanList">
                    {{each(i,item) data}}
                    <tr>
                        <td><a href="/oiling/equdetail/${item.equ_key_no}" target="_blank">${item.equ_oil_name}</a></td>
                        <td>${item.del_warning_time}</td>
                        <td>${item.quantity}</td>
                    </tr>
                    {{/each}}
                </script>
                <div class="tanchuang">
                    <div class="hintl">
                        <div class="hintl-in1">
                            <div class="hintl1"></div>
                            <div class="hintl2">设备保养成本管理</div>
                            <div class="hint3"></div>
                        </div>
                        <div class="hintl-in2">是否删除该条油品信息？</div>
                        <a class="hintl-in3 confirm-del" href="javascript:;">是</a>
                        <a class="hintl-in4" href="javascript:;">否</a>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div id="ft" class="ue-clear">
        <div class="ft-left">
            <span>神华集团</span>
            <em>设备润滑管理系统</em>
        </div>
        <div class="ft-right">
            <span>非同科技</span>
            <em>2017</em>
        </div>
    </div>
</div>
</div>
<?php require(APP_PATH.'/oiling/view/manager/common/exitDialog.html');?>
<?php require(APP_PATH.'/oiling/view/manager/common/footer.html');?>
<script src="__JS__/jquery.monthpicker.js"></script>
<script>
    $(function () {
        var scrollHeight = $(document).height() - $('.scroll-box').offset().top - 27;
        $('.scroll-box').css('height', scrollHeight);

        $('#monthpicker').monthpicker({
            years: [2015, 2014, 2013, 2012, 2011],
            topOffset: 6,
            onMonthSelect: function (m, y) {
                console.log('Month: ' + m + ', year: ' + y);
            }
        });
        var date = new Date(),
            year = date.getFullYear(),
            mouth = (2 + date.getMonth()).toString().length == 1 ? ('0' + (2 + date.getMonth())) : (2 + date.getMonth());
        if (mouth == 13) {
            mouth = 12;
        }
        $('#monthly1').val(year + '-' + '01');
        $('#monthly2').val(year + '-' + mouth);
        $('#monthly1').monthpicker({
            years: [2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025],
            topOffset: 1
        });
        $('#monthly2').monthpicker({
            years: [2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025],
            topOffset: 1
        });
        var before = (new Date($('#monthly1').val()).getTime()) / 1000;
        var after = (new Date($('#monthly2').val()).getTime()) / 1000;
        costList(before, after);

        function costList(before, after) {
            if (before >= after) {
                alert('时间输入有误');
                return false;
            }
            var params = {
                url: '/oiling/oildetail/costlist/' + before + '/' + after + '',
                sCallback: function (list) {
                    $(document).find('#costTbody').html('');
                    $('#costTemplate').tmpl(list).appendTo('#costTbody');
                    $(document).find('tr:odd').css("backgroundColor", "#eff6fa");
                    var totalPrice = 0;
                    $(document).find('.total').each(function (index, value) {
                        totalPrice += parseFloat($(value).text());
                    });
                    console.log(totalPrice);
                    var html = "<span class=\"date\">" + $('#monthly1').val() + "至" + $('#monthly2').val() + "</span>\n" +
                        "<span class=\"zongji\">总计：</span>\n" +
                        "<span class=\"num\">" + totalPrice + "元</span>";
                    $('.total-box').html(html);
                }
            };
            window.base.getData(params);
        }

        $('.cost-confirm').click(function () {
            var before = (new Date($('#monthly1').val()).getTime()) / 1000;
            var after = (new Date($('#monthly2').val()).getTime()) / 1000;
            costList(before, after);
        });
        //编辑润滑标准条目信息
        $(document).on('dblclick', '.edit-item', function (e) {
            var _this = $(this),
                oldVal = _this.html(),
                url = '/oiling/oildetail/edit/';
            oldVal = oldVal.replace(/(^\s*)|(\s*$)/g, "");
            var long = oldVal.length * 12;
            if (!/input/.test(oldVal)) {
                _this.html('<input type="text" value="' + oldVal + '" style="width: ' + long + 'px">');
            }
            var input = _this.find('input');
            input.select();
            window.base.editItemByDblClick(_this, input, oldVal, url);
        });
        $(document).on('click', '.getEquName', function () {
            $('#tanBody').html('');
            var oilNo = $(this).data('oil_no'),
                params = {
                    url: 'oiling/oildetail/equname/' + oilNo,
                    sCallback: function (list) {
                        console.log(list)
                        $('.tanchuang-equlist').show(100);
                        $('#tanList').tmpl(list).appendTo('#tanBody');
                    },
                    eCallback: function (err) {

                    }
                };
            window.base.getData(params);

        });
        $(document).on('click', '.delOilDetailItem', function () {
            $('.tanchuang .hintl').show(100);
            var id = $(this).data('id'),
                _this = $(this);
            $('.confirm-del').click(function (e) {
                e.stopPropagation();
                var params = {
                    url: 'oiling/oildetail/delete/' + id,
                    type: 'delete',
                    sCallback: function (data) {
                        _this.parent().parent().hide(200).remove();
                    }
                };
                window.base.getData(params);
            });
        });
        $('.upload').click(function () {
            var param = $(this).data('param');
            var params = {
                url: "/oiling/upload?" + param,
                data: new FormData($(this).parent()[0]),
                sCallback: function () {
                    alert('上传成功');
                    window.location.reload();
                }
            }
            window.base.uploadFile(params);
        });
    });
</script>